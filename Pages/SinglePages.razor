@page "/singlePages/{subdepartmentID:int}"
@page "/singlePages/{action}/{pageViewID:int}"

@using ITDocumentation.Data
@using Microsoft.EntityFrameworkCore
@using System.Collections.Generic
@inject ApplicationDbContext dbContext



<WhiteContainer>
    <TitleContainer content="@title" 
        showTooltip="true"
        toolTipMessage="@toolTipMessage"
        />
    <br>
    @{
        if (showAlert == true)
        {
            <AlertMessage content="@alertMessage"
                          alertType="@alertType"
                          HideAlert__ParentEvent="@HideAlert" />


        }

    }

    @{

        if (action == "view")
        {
            <PageView pageType="singlePage"
                      pageID="@pageViewID"
                      setState__parentEvent="@SetState__event"
                      setSinglePage__parentEvent="@SetSinglePage" />
        }


        if (state == "records" && action != "view")
        {

            <CRUDTable subdepartmentID="@subdepartmentID" action="add">
                <RadzenButton Icon="add_circle_outline" Class="mt-2 mb-4" Text="Create Page" Click="@(args => CreatePage())" />
            </CRUDTable>
            <SinglePagesTable pages="@pages"
                              SetState__parentEvent="@SetState__event"
                              subdepartmentID="@subdepartmentID"
                              SetSinglePage__parentEvent="@SetSinglePage"
                              SetAlertMessage__ParentEvent="@SetAlertMessage"
                              SetAlertType__ParentEvent="@SetAlertType"
                              ShowAlert__ParentEvent="@ShowAlert"
                              ReloadPages__parentEvent="@ReloadPages" />
        }

        if (state == "create")
        {
            <SinglePageForm subdepartmentID="@subdepartmentID"
                            SetState__ParentEvent="@SetState__event"
                            singlePage="@singlePage"
                            state="create"
                            SetAlertMessage__ParentEvent="@SetAlertMessage"
                            SetAlertType__ParentEvent="@SetAlertType"
                            ShowAlert__ParentEvent="@ShowAlert"
                            ReloadPage__ParentEvent="@ReloadPage"
                            SetSinglePage__parentEvent="@SetSinglePage" />
        }

        if (state == "update")
        {

            <SinglePageForm subdepartmentID="@subdepartmentID"
                            SetState__ParentEvent="@SetState__event"
                            singlePage="@singlePage"
                            state="update"
                            SetAlertMessage__ParentEvent="@SetAlertMessage"
                            SetAlertType__ParentEvent="@SetAlertType"
                            ShowAlert__ParentEvent="@ShowAlert"
                            ReloadPage__ParentEvent="@ReloadPage"
                            SetSinglePage__parentEvent="@SetSinglePage" />
        }

        if (state == "view")
        {
            if (pageID != -1)
            {
                <PageView pageType="singlePage"
                          pageID="@singlePage!.ID"
                          setState__parentEvent="@SetState__event"
                          setSinglePage__parentEvent="@SetSinglePage" />
            }

        }


    }
</WhiteContainer>


@code
{


    [Parameter]
    public string action { get; set; }
    [Parameter]
    public int pageViewID { get; set; }
    [Parameter]
    public int subdepartmentID { get; set; }
    [Parameter]
    public IList<SinglePage>? pages { get; set; }
    int pageID = -1;
    string state = "records";
    string title = "Pages";
    string pageContent;
    public SinglePage singlePage;

    bool showAlert = false;
    string alertMessage = "";
    string alertType = "alert alert-primary";
    string toolTipMessage = "A Page is used to created content and store documents related to that specific content.";


    protected override async Task OnInitializedAsync()
    {


        if (state == "update")
        {
            if (dbContext.SinglePage.Any(p => p.ID == pageViewID))
            {
                singlePage = dbContext.SinglePage.First(p => p.ID == pageViewID);

            }

        }
        else
        
        {
            singlePage = new SinglePage();

        }
        pages = dbContext.SinglePage.Where(p => p.SubdepartmentID == subdepartmentID).ToList();


    }

    void ReloadPage()
    {

        singlePage = dbContext.SinglePage.First(s => s.ID == singlePage.ID);
    }

    void ReloadPages()
    {
        pages = dbContext.SinglePage.Where(p => p.SubdepartmentID == subdepartmentID).ToList();
    }

    void SetState__event(string state)
    {
        this.action = "";
        this.state = state;

    }

    void LoadPageContent__event(SinglePage singlePage)
    {
        title = singlePage.Name;
        pageContent = singlePage.PageContent;


    }

    void CreatePage()
    {
        state = "create";
        singlePage = new SinglePage();
    }



    void SetSinglePage(SinglePage singlePage)
    {
        pageID = singlePage.ID;
        this.singlePage = singlePage;
    }

    void ShowAlert(bool showAlert)

    {
        this.showAlert = showAlert;


    }



    void HideAlert()
    {

        this.showAlert = false;
    }



    void SetAlertMessage(string alertMessage)
    {
        this.alertMessage = alertMessage;

    }

    void SetAlertType(string alertType)
    {
        this.alertType = alertType;


    }

}